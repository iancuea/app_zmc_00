{% extends "core/base.html" %}
{% load static %}

{% block content %}
<div class="dashboard-header">
    <div class="title-section">
        <h1 class="page-title">Gesti칩n de Unidades</h1>
        <p class="page-subtitle">Monitoreo de estado t칠cnico y documentaci칩n en tiempo real.</p>
    </div>
    
    <form method="get" class="filter-card">
        <div class="filter-group">
            <label>Estado de Salud</label>
            <select name="estado" class="pro-input">
                <option value="">Todos los estados</option>
                <option value="VENCIDA" {% if request.GET.estado == 'VENCIDA' %}selected{% endif %}>游댮 Vencida</option>
                <option value="CRITICA" {% if request.GET.estado == 'CRITICA' %}selected{% endif %}>游리 Cr칤tica</option>
                <option value="OK" {% if request.GET.estado == 'OK' %}selected{% endif %}>游릭 OK</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Priorizar por</label>
            <select name="orden" class="pro-input">
                <option value="">Normal (Por Base)</option>
                <option value="urgencia" {% if request.GET.orden == 'urgencia' %}selected{% endif %}>游뚿 Mayor Urgencia</option>
            </select>
        </div>

        <button type="submit" class="btn-primary-pro">Actualizar Vista</button>
    </form>
</div>

<div class="table-container-pro">
    <table class="tabla-pro">
        <thead>
            <tr>
                <th>Unidad</th>
                <th>Especificaciones</th>
                <th>Ubicaci칩n</th>
                <th>Estado Operativo</th>
                <th>Mec치nica</th>
                <th>Motivos y Alertas</th>
            </tr>
        </thead>
        <tbody>
            {% for grupo in camiones_por_base %}
                <tr class="base-row-divider">
                    <td colspan="6">Base Actual: <strong>{{ grupo.base }}</strong></td>
                </tr>

                {% for camion in grupo.camiones %}
                    {% with estado_t=camion.get_salud_completa asignacion=camion.asignacion_actual %}
                    <tr class="unit-row {{ estado_t.css }}" data-camion-id="{{ camion.id_camion }}">
                        <td class="col-patente">
                            <a href="{% url 'camion_detail' camion.id_camion %}" class="patente-pill">
                                {{ camion.patente }}
                            </a>
                        </td>
                        <td>
                            <div class="unit-specs">
                                <span class="spec-type">{{ camion.tipo_camion }}</span>
                                <span class="spec-rol">{{ camion.rol_operativo }}</span>
                            </div>
                        </td>
                        <td class="col-base">{{ grupo.base }}</td>
                        <td>
                            <span class="badge-op-status">
                                {{ camion.estado_actual.get_estado_operativo_display|default:"Sin Datos" }}
                            </span>
                        </td>
                        <td class="col-health">
                            <div class="health-indicator">
                                <span class="health-dot"></span>
                                <strong>{{ estado_t.label }}</strong>
                            </div>
                        </td>
                        <td class="motivos">
                            <span class="loader-dots">Cargando detalles...</span>
                        </td>
                    </tr>
                    {% if asignacion %}
                        {% with remolque=asignacion.remolque %}
                        <tr class="trailer-row" data-remolque-id="{{ remolque.id_remolque }}">
                            <td class="trailer-patente">
                                <span class="connector-line"></span>
                                <a href="{% url 'remolque_detail' remolque.id_remolque %}">
                                    {{ remolque.patente }}
                                </a>
                            </td>
                            <td colspan="2" class="trailer-label">Remolque Vinculado</td>
                            <td>{{ remolque.estado_actual.get_estado_operativo_display|default:"OPERATIVO" }}</td>
                            <td class="estado-mantencion-texto-rem">OK</td>
                            <td class="motivos-remolque">Cargando...</td>
                        </tr>
                        {% endwith %}
                    {% endif %}
                    {% endwith %}
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="{% static 'core/js/camiones.js' %}"></script>
{% endblock %}