{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Listado de Camiones</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'core/css/camiones.css' %}">
</head>
<body>

<h1>Listado de Camiones</h1>

<!-- FILTRO Y ORDEN (backend, NO se toca) -->
<form method="get" style="margin-bottom: 1rem;">
    <label>Estado mantención:</label>
    <select name="estado">
        <option value="">Todos</option>
        <option value="VENCIDA">Vencida</option>
        <option value="CRITICA">Crítica</option>
        <option value="OK">OK</option>
        <option value="SIN_DATOS">Sin datos</option>
    </select>

    <label style="margin-left: 1rem;">Orden:</label>
    <select name="orden">
        <option value="">Normal</option>
        <option value="urgencia">Por urgencia</option>
    </select>

    <button type="submit">Aplicar</button>
</form>

<table class="tabla-camiones" id="tabla-camiones">
    <thead>
        <tr>
            <th>Patente</th>
            <th>Tipo</th>
            <th>Rol</th>
            <th>Base</th>
            <th>Activo</th>
            <th>Estado Operativo</th>
            <th>Mantención</th>
            <th>Conductor</th>
            <th>Motivos</th>
        </tr>
    </thead>

    <tbody>
    {% for grupo in camiones_por_base %}
        <tr class="separador-base">
            <td colspan="9">BASE: {{ grupo.base|upper }}</td>
        </tr>

        {% for camion in grupo.camiones %}
            {% with estado_t=camion.estado_mantencion asignacion=camion.asignacion_actual %}
            
            <tr class="{{ estado_t.css }}" data-camion-id="{{ camion.id_camion }}">
                <td>
                    <a href="{% url 'camion_detail' camion.id_camion %}">
                        {{ camion.patente }}
                    </a>
                </td>
                <td>{{ camion.tipo_camion }}</td>
                <td>{{ camion.rol_operativo }}</td>
                <td>{{ camion.estado_actual.get_base_actual_display|default:"—" }}</td>
                <td>{{ camion.activo|yesno:"Sí,No" }}</td>
                <td>{{ camion.estado_actual.estado_operativo|default:"—" }}</td>
                <td class="estado-mantencion">{{ estado_t.label }}</td>
                <td>{{ camion.estado_actual.conductor|default:"—" }}</td>
                <td class="motivos">Cargando...</td>
            </tr>

            {% if asignacion %}
                {% with remolque=asignacion.remolque %}
                <tr class="fila-remolque" data-remolque-id="{{ remolque.id_remolque }}">
                    <td style="padding-left: 25px;">
                        <span class="flecha-vinculo">↳</span> 
                        <strong>{{ remolque.patente }}</strong>
                    </td>
                    <td>REMOLQUE</td>
                    <td style="color: #888; font-style: italic;">(Heredado)</td>
                    <td>{{ camion.estado_actual.get_base_actual_display|default:"—" }}</td>
                    <td>{{ remolque.activo|yesno:"Sí,No" }}</td>
                    <td>{{ remolque.estado_operativo }}</td>
                    
                    <td class="estado-mantencion">
                        {# Aquí asumo que crearás una lógica similar a estado_mantencion para Remolque #}
                        {{ remolque.estado_mantencion.label|default:"OK" }}
                    </td>

                    <td>{{ camion.estado_actual.conductor|default:"—" }}</td>
                    <td>Vínculo: {{ asignacion.fecha_desde|date:"d/m/Y" }}</td>
                </tr>
                {% endwith %}
            {% endif %}

            {% endwith %}
        {% endfor %}
    {% endfor %}
</tbody>
</table>

<!-- JS -->
<script src="{% static 'core/js/camiones.js' %}"></script>

</body>
</html>
