{% extends "core/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container-detail">
    <div class="header-camion">
        <h2>Unidad: <span class="patente-destacada">{{ camion.patente }}</span></h2>
        <a href="{% url 'camion_list' %}" class="btn-volver">‚Üê Volver al listado</a>
    </div>

    {% with estado_mant=camion.estado_mantencion %}
    <div class="card-hero {{ estado_mant.css }} {{ estado_mant.codigo }}">
        <div class="hero-info">
            <span class="urgencia-tag">ESTADO ACTUAL</span>
            <h1 class="label-gigante">{{ estado_mant.label }}</h1>
            
            {% if estado_mant.codigo == "VENCIDA" %}
                <strong>‚ö†Ô∏è REQUIERE TALLER INMEDIATO</strong>
            {% elif estado_mant.codigo == "CRITICA" %}
                <strong>‚è≥ AGENDAR PR√ìXIMA SEMANA</strong>
            {% else %}
                <strong>‚úÖ VEH√çCULO AL D√çA</strong>
            {% endif %}
        </div>
        
        <div class="hero-stats">
            {% with ultima=mantenciones.0 %}
            <div class="stat-item">
                <small>KM RESTANTES</small><br>
                <strong>{{ ultima.km_restantes_calculados|intcomma|default:"‚Äî" }} km</strong>
            </div>
            <div class="stat-item">
                <small>PR√ìXIMA MANTENCI√ìN</small><br>
                <strong>{{ ultima.km_proxima_mantencion|intcomma }} km</strong>
            </div>
            {% endwith %}
        </div>
    </div>
    {% endwith %}

   <div class="grid-detalles">
        <div class="card">
            <h3>Estado Operativo</h3>
            <div class="info-row">
                <strong>Kilometraje Actual:</strong>
                <span>{{ estado.kilometraje|intcomma }} km</span>
            </div>
            <div class="info-row">
                <strong>Operatividad:</strong>
                <span class="badge {% if estado.estado_operativo == 'OPERATIVO' %}bg-ok{% else %}bg-danger{% endif %}">
                    {{ estado.get_estado_operativo_display|default:"OPERATIVO" }}
                </span>
            </div>
            <p style="margin-top: 10px;">
                <strong>Observaci√≥n:</strong><br>
                <small>{{ estado.observacion|default:"Sin observaciones t√©cnicas." }}</small>
            </p>
        </div>

        {% if "TRACTO" in camion.tipo_camion.upper or camion.tiene_remolque %}
            <div class="card">
                <h3>Equipo Asignado (Remolque)</h3>
                {% with asignacion=camion.asignacion_actual %}
                    {% if asignacion %}
                        <div class="info-row">
                            <strong>Patente:</strong>
                            <span class="patente-badge">{{ asignacion.remolque.patente }}</span>
                        </div>
                        <div class="info-row">
                            <strong>Kilometraje:</strong>
                            <span>{{ asignacion.remolque.kilometraje_acumulado|intcomma }} km</span>
                        </div>
                        <p style="margin-top:20px;">
                            <a href="{% url 'remolque_detail' asignacion.remolque.id_remolque %}" class="btn-link">
                                Ir a ficha de remolque ‚Üí
                            </a>
                        </p>
                    {% else %}
                        <div style="text-align: center; padding: 10px;">
                            <p style="color: #999; font-style: italic;">Sin remolque vinculado</p>
                            <span style="font-size: 1.5rem;">üîì</span>
                        </div>
                    {% endif %}
                {% endwith %}
            </div>
        {% else %}
            <div class="card">
                <h3>Especificaciones de Unidad</h3>
                <div class="info-row">
                    <strong>Tipo de Cami√≥n:</strong>
                    <span>{{ camion.tipo_camion }}</span>
                </div>
                <div class="info-row">
                    <strong>Capacidad:</strong>
                    <span>{{ camion.capacidad_m3 }} m¬≥</span>
                </div>
                <p style="margin-top: 15px; color: #666; font-size: 0.85rem;">
                    Unidad r√≠gida de operaci√≥n aut√≥noma. No requiere equipo de arrastre adicional.
                </p>
            </div>
        {% endif %}
    </div>
    

    <div class="card" style="width: 100%;">
        <h3>Historial Reciente de Mantenciones</h3>
        <table class="tabla-camiones">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Km Realizada</th>
                    <th>Pr√≥xima</th>
                    <th>Taller</th>
                    <th>Observaciones</th>
                </tr>
            </thead>
            <tbody>
                {% for m in mantenciones %}
                <tr>
                    <td>{{ m.fecha_mantencion }}</td>
                    <td>{{ m.km_mantencion|intcomma }} km</td>
                    <td>{{ m.km_proxima_mantencion|intcomma }} km</td>
                    <td>{{ m.taller }}</td>
                    <td>{{ m.observaciones|default:"-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}