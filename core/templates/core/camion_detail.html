{% extends "core/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container-detail">
    <div class="header-camion">
        <h2>Unidad: <span class="patente-destacada">{{ camion.patente }}</span></h2>
        <a href="{% url 'camion_list' %}" class="btn-volver">← Volver al listado</a>
    </div>

    {% with estado_mant=camion.estado_mantencion %}
    <div class="card-hero {{ estado_mant.css }} {{ estado_mant.codigo }}">
        <div class="hero-info">
            <span class="urgencia-tag">ESTADO ACTUAL</span>
            <h1 class="label-gigante">{{ estado_mant.label }}</h1>
            
            {% if estado_mant.codigo == "VENCIDA" %}
                <strong>⚠️ REQUIERE TALLER INMEDIATO</strong>
            {% elif estado_mant.codigo == "CRITICA" %}
                <strong>⏳ AGENDAR PRÓXIMA SEMANA</strong>
            {% else %}
                <strong>✅ VEHÍCULO AL DÍA</strong>
            {% endif %}
        </div>
        
        <div class="hero-stats">
            {% with ultima=mantenciones.0 %}
            <div class="stat-item">
                <small>KM RESTANTES</small><br>
                <strong>{{ ultima.km_restantes_calculados|intcomma|default:"—" }} km</strong>
            </div>
            <div class="stat-item">
                <small>PRÓXIMA MANTENCIÓN</small><br>
                <strong>{{ ultima.km_proxima_mantencion|intcomma }} km</strong>
            </div>
            {% endwith %}
        </div>
    </div>
    {% endwith %}

    <div class="grid-detalles">
        <div class="card">
            <h3>Estado Operativo</h3>
            <div class="info-row">
                <strong>Kilometraje Actual:</strong>
                <span>{{ estado.kilometraje|intcomma }} km</span>
            </div>
            <div class="info-row">
                <strong>Operatividad:</strong>
                <span class="badge {% if estado.estado_operativo == 'OPERATIVO' %}bg-ok{% else %}bg-danger{% endif %}">
                    {{ estado.get_estado_operativo_display|default:"OPERATIVO" }}
                </span>
            </div>
            <p><strong>Observación:</strong><br><small>{{ estado.observacion|default:"Sin observaciones técnicas." }}</small></p>
        </div>

        <div class="card">
            <h3>Equipo Asignado (Remolque)</h3>
            {% with asignacion=camion.asignacion_actual %}
                {% if asignacion %}
                    <div class="info-row">
                        <strong>Patente:</strong>
                        <span class="patente-destacada" style="font-size: 0.9rem;">{{ asignacion.remolque.patente }}</span>
                    </div>
                    <div class="info-row">
                        <strong>Kilometraje:</strong>
                        <span>{{ asignacion.remolque.kilometraje_acumulado|intcomma }} km</span>
                    </div>
                    <p style="margin-top:15px;"><a href="#">Ir a ficha de remolque →</a></p>
                {% else %}
                    <p style="color: #999; font-style: italic;">No tiene remolque vinculado actualmente.</p>
                {% endif %}
            {% endwith %}
        </div>
    </div>

    <div class="card" style="width: 100%;">
        <h3>Historial Reciente de Mantenciones</h3>
        <table class="tabla-camiones">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Km Realizada</th>
                    <th>Próxima</th>
                    <th>Taller</th>
                    <th>Observaciones</th>
                </tr>
            </thead>
            <tbody>
                {% for m in mantenciones %}
                <tr>
                    <td>{{ m.fecha_mantencion }}</td>
                    <td>{{ m.km_mantencion|intcomma }} km</td>
                    <td>{{ m.km_proxima_mantencion|intcomma }} km</td>
                    <td>{{ m.taller }}</td>
                    <td>{{ m.observaciones|default:"-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}