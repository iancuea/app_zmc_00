{% extends 'mantenciones/base.html' %}
{% load static %}

{% block title %}Crear Inspecci贸n{% endblock %}

{% block content %}
<div class="container-fluid mt-5">
    <div class="row">
        <div class="col-12">
            <h1> Nueva Inspecci贸n</h1>
            <hr>
        </div>
    </div>

    <!-- FORMULARIO PRINCIPAL -->
    <form id="inspeccion-form" method="post">
        {% csrf_token %}
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="id_tipo_inspeccion">Tipo de Inspecci贸n *</label>
                    {{ form.tipo_inspeccion }}
                    {% if form.tipo_inspeccion.errors %}
                        <div class="alert alert-danger mt-2">{{ form.tipo_inspeccion.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="id_vehiculo">Patente Cami贸n *</label>
                    {{ form.vehiculo }}
                    {% if form.vehiculo.errors %}
                        <div class="alert alert-danger mt-2">{{ form.vehiculo.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- DATOS AUTO-COMPLETADOS (OCULTOS) -->
        <div class="row mb-4" id="datos-autocompletados" style="display: none;">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Lugar de Inspecci贸n:</label>
                    <input type="text" id="lugar-inspeccion" class="form-control" disabled>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label>Conductor:</label>
                    <input type="text" id="conductor-nombre" class="form-control" disabled>
                </div>
            </div>
        </div>

        <!-- REMOLQUE (SI APLICA) -->
        <div class="row mb-4" id="seccion-remolque" style="display: none;">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Patente Remolque (Auto-asignado):</label>
                    <input type="text" id="remolque-patente" class="form-control" disabled>
                    {{ form.remolque }}
                </div>
            </div>
        </div>

        <!-- RESPONSABLE Y KM -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="id_responsable">Responsable de Inspecci贸n *</label>
                    {{ form.responsable }}
                    {% if form.responsable.errors %}
                        <div class="alert alert-danger mt-2">{{ form.responsable.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="id_km_registro">Kilometraje Actual *</label>
                    {{ form.km_registro }}
                    {% if form.km_registro.errors %}
                        <div class="alert alert-danger mt-2">{{ form.km_registro.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ESTADO Y OBSERVACIONES -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="form-check form-switch">
                    {{ form.es_apto_operar }}
                    <label class="form-check-label" for="id_es_apto_operar">
                        驴Apto para Operar?
                    </label>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="form-group">
                    <label for="id_observaciones">Observaciones Generales</label>
                    {{ form.observaciones }}
                </div>
            </div>
        </div>

        <hr>

        <!-- CHECKLIST DINMICO -->
        <div class="row mb-4">
            <div class="col-12">
                <h3> Checklist de Inspecci贸n</h3>
                <div id="categorias-checklist">
                    <p class="text-muted">Selecciona tipo de inspecci贸n y cami贸n para ver el checklist...</p>
                </div>
            </div>
        </div>

        <!-- BOTONES -->
        <div class="row mb-4">
            <div class="col-12">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save"></i> Guardar Inspecci贸n y Generar PDF
                </button>
                <a href="{% url 'camion_list' %}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </div>

        <!-- CAMPO OCULTO PARA ENVIAR DATOS DEL CHECKLIST -->
        <input type="hidden" id="resultados-checklist" name="resultados_checklist" value="[]">

    </form>
</div>

<!-- JAVASCRIPT PARA FUNCIONAMIENTO DINMICO -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoInspeccionSelect = document.getElementById('id_tipo_inspeccion');
    const vehiculoSelect = document.getElementById('id_vehiculo');
    const categoriasChecklistDiv = document.getElementById('categorias-checklist');
    const resultadosChecklistInput = document.getElementById('resultados-checklist');
    const datosAutocompletadosDiv = document.getElementById('datos-autocompletados');
    const seccionRemolqueDiv = document.getElementById('seccion-remolque');
    const lugarInspeccionInput = document.getElementById('lugar-inspeccion');
    const conductorNombreInput = document.getElementById('conductor-nombre');
    const remolquePatente = document.getElementById('remolque-patente');

    // Evento cuando cambia el tipo de inspecci贸n
    tipoInspeccionSelect.addEventListener('change', cargarCategorias);
    
    // Evento cuando cambia el veh铆culo
    vehiculoSelect.addEventListener('change', cargarDatosAutocompletados);

    async function cargarCategorias() {
        const tipoInspeccion = tipoInspeccionSelect.value;
        if (!tipoInspeccion) {
            categoriasChecklistDiv.innerHTML = '<p class="text-muted">Selecciona un tipo de inspecci贸n...</p>';
            return;
        }

        try {
            const response = await fetch(`/mantenciones/api/categorias/${tipoInspeccion}/`);
            const data = await response.json();

            if (data.success) {
                renderizarCategorias(data.categorias);
            } else {
                categoriasChecklistDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            }
        } catch (error) {
            console.error('Error cargando categor铆as:', error);
            categoriasChecklistDiv.innerHTML = '<div class="alert alert-danger">Error al cargar checklist</div>';
        }
    }

    async function cargarDatosAutocompletados() {
        const camionId = vehiculoSelect.value;
        if (!camionId) {
            datosAutocompletadosDiv.style.display = 'none';
            seccionRemolqueDiv.style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`/mantenciones/api/datos-autocompletado/${camionId}/`);
            const data = await response.json();

            if (data.success) {
                const datos = data.datos;
                lugarInspeccionInput.value = datos.lugar_inspeccion;
                conductorNombreInput.value = datos.conductor_nombre;
                datosAutocompletadosDiv.style.display = 'flex';

                // Mostrar remolque si existe
                if (datos.tiene_remolque) {
                    remolquePatente.value = datos.remolque_patente;
                    document.getElementById('id_remolque').value = datos.remolque_id || '';
                    seccionRemolqueDiv.style.display = 'flex';
                } else {
                    seccionRemolqueDiv.style.display = 'none';
                    document.getElementById('id_remolque').value = '';
                }

                // Recargar categor铆as si ya hay una seleccionada
                if (tipoInspeccionSelect.value) {
                    cargarCategorias();
                }
            }
        } catch (error) {
            console.error('Error cargando datos:', error);
        }
    }

    function renderizarCategorias(categorias) {
        let html = '';

        categorias.forEach(categoria => {
            html += `
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">${categoria.nombre}</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>N掳</th>
                                        <th>Descripci贸n</th>
                                        <th colspan="3" class="text-center">Respuesta</th>
                                        <th>Observaci贸n</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            categoria.items.forEach((item, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.nombre}</td>
                        <td class="text-center">
                            <input type="radio" name="estado_${item.id}" value="B" class="form-check-input item-radio" 
                                   data-item-id="${item.id}"> B
                        </td>
                        <td class="text-center">
                            <input type="radio" name="estado_${item.id}" value="R" class="form-check-input item-radio" 
                                   data-item-id="${item.id}"> R
                        </td>
                        <td class="text-center">
                            <input type="radio" name="estado_${item.id}" value="M" class="form-check-input item-radio" 
                                   data-item-id="${item.id}"> M
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm item-observacion" 
                                   data-item-id="${item.id}" placeholder="Obs...">
                        </td>
                    </tr>
                `;
            });

            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        });

        categoriasChecklistDiv.innerHTML = html;

        // Agregar event listeners a los radios
        document.querySelectorAll('.item-radio').forEach(radio => {
            radio.addEventListener('change', actualizarChecklist);
        });

        // Agregar event listeners a las observaciones
        document.querySelectorAll('.item-observacion').forEach(input => {
            input.addEventListener('input', actualizarChecklist);
        });
    }

    function actualizarChecklist() {
        const resultados = [];
        
        document.querySelectorAll('.item-radio:checked').forEach(radio => {
            const itemId = radio.dataset.itemId;
            const observacion = document.querySelector(`.item-observacion[data-item-id="${itemId}"]`).value;
            
            resultados.push({
                item_id: itemId,
                estado: radio.value,
                observacion: observacion
            });
        });

        resultadosChecklistInput.value = JSON.stringify(resultados);
    }

    // Validar antes de enviar
    document.getElementById('inspeccion-form').addEventListener('submit', function(e) {
        const tipoInspeccion = tipoInspeccionSelect.value;
        const vehiculo = vehiculoSelect.value;
        const km = document.getElementById('id_km_registro').value;
        const responsable = document.getElementById('id_responsable').value;
        const resultados = JSON.parse(resultadosChecklistInput.value || '[]');

        if (!tipoInspeccion || !vehiculo || !km || !responsable) {
            e.preventDefault();
            alert('Por favor completa todos los campos requeridos');
            return false;
        }

        if (resultados.length === 0) {
            e.preventDefault();
            alert('Por favor completa el checklist de inspecci贸n');
            return false;
        }
    });
});
</script>

<style>
.item-radio {
    cursor: pointer;
}

.table-responsive {
    font-size: 0.9rem;
}

.card-header {
    background-color: #0056b3 !important;
}
</style>

{% endblock %}